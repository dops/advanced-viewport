
(function(a){a.widget("dops.viewport",{options:{threshold:0,thresholdTop:null,thresholdBottom:null,thresholdLeft:null,thresholdRight:null,segmentation:{topBottom:"50:50",leftRight:"50:50"},showViewports:false},viewport:{top:{top:null,bottom:null,left:null,right:null},bottom:{top:null,bottom:null,left:null,right:null},left:{top:null,bottom:null,left:null,right:null},right:{top:null,bottom:null,left:null,right:null},overall:{top:null,bottom:null,left:null,right:null}},viewportDisplayColors:{top:"red",bottom:"blue",left:"green",right:"yellow",overall:"pink"},state:{top:false,bottom:false,left:false,right:false,above:false,below:false,leftOf:false,rightOf:false,overall:false},percent:{top:0,bottom:0,left:0,right:0,overall:0},_create:function(){this._setThresholds();this._addEventhandlers();this.inViewport();this._displayViewports();return this},_setThresholds:function(){if(this.options.thresholdTop===null){this.options.thresholdTop=this.options.threshold}if(this.options.thresholdBottom===null){this.options.thresholdBottom=this.options.threshold}if(this.options.thresholdLeft===null){this.options.thresholdLeft=this.options.threshold}if(this.options.thresholdRight===null){this.options.thresholdRight=this.options.threshold}return true},_detectViewport:function(){scrollTop=a(window).scrollTop();scrollLeft=a(window).scrollLeft();height=a(window).height();width=a(window).width();this.viewport.overall={top:scrollTop+this.options.thresholdTop,bottom:scrollTop+height-this.options.thresholdBottom,left:scrollLeft+this.options.thresholdLeft,right:scrollLeft+width-this.options.thresholdRight,height:height-this.options.thresholdBottom-this.options.thresholdTop,width:width-this.options.thresholdRight-this.options.thresholdLeft};segmentation=this.options.segmentation.topBottom.split(":");topSegment=parseInt(segmentation[0],10);bottomSegment=parseInt(segmentation[1],10);this._detectTopViewport(segmentation[0]);this._detectBottomViewport(segmentation[1]);segmentation=this.options.segmentation.leftRight.split(":");leftSegment=parseInt(segmentation[0],10);rightSegment=parseInt(segmentation[1],10);this._detectLeftViewport(segmentation[0]);this._detectRightViewport(segmentation[1]);return true},_detectTopViewport:function(b){if(parseInt(b,10)==b||b.match(/%/)){value=(b.match(/%/))?parseInt(b.replace(/%/,""),10):parseInt(b,10);this.viewport.top=jQuery.extend({},this.viewport.overall);this.viewport.top.bottom=this.viewport.overall.height/100*value+this.viewport.overall.top;this.viewport.top.height=this.viewport.overall.height/100*value}else{if(b.match(/px/)){value=parseInt(b.replace(/px/,""),10);this.viewport.top=jQuery.extend({},this.viewport.overall);this.viewport.top.bottom=value+this.viewport.overall.top;this.viewport.top.height=value}}return true},_detectBottomViewport:function(b){if(parseInt(b,10)==b||b.match(/%/)){value=(b.match(/%/))?parseInt(b.replace(/%/,""),10):parseInt(b,10);this.viewport.bottom=jQuery.extend({},this.viewport.overall);this.viewport.bottom.top=this.viewport.overall.height-(this.viewport.overall.height/100*value)+this.viewport.overall.top;this.viewport.bottom.height=this.viewport.overall.height/100*value}else{if(b.match(/px/)){value=parseInt(b.replace(/px/,""),10);this.viewport.bottom=jQuery.extend({},this.viewport.overall);this.viewport.bottom.top=this.viewport.overall.height-value+this.viewport.overall.top;this.viewport.bottom.height=value}}return true},_detectLeftViewport:function(b){if(parseInt(b,10)==b||b.match(/%/)){value=(b.match(/%/))?parseInt(b.replace(/%/,""),10):parseInt(b,10);this.viewport.left=jQuery.extend({},this.viewport.overall);this.viewport.left.right=this.viewport.overall.width/100*leftSegment+this.viewport.overall.left;this.viewport.left.width=this.viewport.overall.width/100*leftSegment}else{if(b.match(/px/)){value=parseInt(b.replace(/px/,""),10);this.viewport.left=jQuery.extend({},this.viewport.overall);this.viewport.left.right=value+this.viewport.overall.left;this.viewport.left.width=value}}return true},_detectRightViewport:function(b){if(parseInt(b,10)==b||b.match(/%/)){value=(b.match(/%/))?parseInt(b.replace(/%/,""),10):parseInt(b,10);this.viewport.right=jQuery.extend({},this.viewport.overall);this.viewport.right.left=this.viewport.overall.width-(this.viewport.overall.width/100*rightSegment)+this.viewport.overall.left;this.viewport.right.width=this.viewport.overall.width/100*rightSegment}else{if(b.match(/px/)){value=parseInt(b.replace(/px/,""),10);this.viewport.right=jQuery.extend({},this.viewport.overall);this.viewport.right.left=this.viewport.overall.width-value+this.viewport.overall.left;this.viewport.right.width=value}}return true},_detectElementPosition:function(){offset=a(this.element).offset();height=a(this.element).outerHeight();width=a(this.element).outerWidth();this.elementBox={top:offset.top,bottom:offset.top+height,left:offset.left,right:offset.left+width,height:height,width:width};return true},_addEventhandlers:function(){that=this;this._on(a(window),{resize:"inViewport",scroll:"inViewport"});this._on(a(window),{resize:function(b){that.inViewport();that._displayViewports()},scroll:function(b){that.inViewport();that._displayViewports()}});return true},_setTopState:function(){stateAbove=(this.elementBox.bottom<this.viewport.top.top)?true:false;if(stateAbove!==this.state.above){this.state.above=stateAbove;this._trigger((stateAbove)?"aboveViewport":"notAboveViewport",null,{state:this.state,percent:this.percent})}stateTop=(this.percent.top>0)?true:false;if(stateTop!==this.state.top){this.state.top=stateTop;this._trigger((stateTop)?"inTopViewport":"notInTopViewport",null,{state:this.state,percent:this.percent})}return true},_setBottomState:function(){stateBelow=(this.elementBox.top>this.viewport.bottom.left)?true:false;if(stateBelow!==this.state.below){this.state.below=stateBelow;this._trigger((stateBelow)?"belowViewport":"notBelowViewport",null,{state:this.state,percent:this.percent})}stateBottom=(this.percent.bottom>0)?true:false;if(stateBottom!==this.state.bottom){this.state.bottom=stateBottom;this._trigger((stateBottom)?"inBottomViewport":"notInBottomViewport",null,{state:this.state,percent:this.percent})}return true},_setLeftState:function(){stateLeftOf=(this.elementBox.right<this.viewport.left.left)?true:false;if(stateLeftOf!==this.state.leftOf){this.state.leftOf=stateLeftOf;this._trigger((stateLeftOf)?"leftOfViewport":"notLeftOfViewport",null,{state:this.state,percent:this.percent})}stateLeft=(this.percent.left>0)?true:false;if(stateLeft!==this.state.left){this.state.left=stateLeft;this._trigger((stateLeft)?"inTopLeftport":"notInLeftViewport",null,{state:this.state,percent:this.percent})}return true},_setRightState:function(){stateRightOf=(this.elementBox.left>this.viewport.right.right)?true:false;if(stateRightOf!==this.state.rightOf){this.state.rightOf=stateRightOf;this._trigger((stateRightOf)?"rightOfViewport":"notRightOfViewport",null,{state:this.state,percent:this.percent})}stateRight=(this.percent.right>0)?true:false;if(stateRight!==this.state.right){this.state.right=stateRight;this._trigger((stateRight)?"inRightViewport":"notInRightViewport",null,{state:this.state,percent:this.percent})}return true},_setOverallState:function(){stateOverall=(this.percent.overall>0)?true:false;if(stateOverall!==this.state.overall){this.state.overall=stateOverall;this._trigger((stateOverall===true)?"inViewport":"notInViewport",null,{state:this.state,percent:this.percent})}return true},_setState:function(){oldPercent=this.percent;this._setTopState();this._setBottomState();this._setLeftState();this._setRightState();this._setOverallState();this._manageClassAdditions();if(JSON.stringify(oldPercent)===JSON.stringify(this.percent)){this._trigger("positionUpdate",null,{state:this.state,percent:this.percent})}return true},_manageClassAdditions:function(){inAnyViewport=false;elem=a(this.element);for(viewport in this.state){if(this.state[viewport]===true){inAnyViewport=true;elem.addClass("in-"+viewport+"-viewport")}else{elem.removeClass("in-"+viewport+"-viewport")}}if(inAnyViewport){elem.addClass("in-viewport")}else{elem.addRemove("in-viewport")}return true},inViewport:function(c){this._detectViewport();this._detectElementPosition();this.inTopViewport();this.inBottomViewport();this.inLeftViewport();this.inRightViewport();maxPercent=this.elementBox.height/100*this.viewport.overall.height;maxPercent=(maxPercent>100)?100:maxPercent;var b={top:0,bottom:0,left:0,right:0};if(this.elementBox.bottom>this.viewport.overall.top&&this.elementBox.top<this.viewport.overall.bottom){pxIn=this.elementBox.bottom-this.viewport.overall.top;b.top=maxPercent/this.elementBox.height*pxIn;b.top=(b.top>100)?100:b.top}if(this.elementBox.top<this.viewport.overall.bottom&&this.elementBox.bottom>this.viewport.overall.top){pxIn=this.viewport.overall.bottom-this.elementBox.top;b.bottom=maxPercent/this.elementBox.height*pxIn;b.bottom=(b.bottom>100)?100:b.bottom}if(this.elementBox.right>this.viewport.overall.left&&this.elementBox.left<this.viewport.overall.right){pxIn=this.elementBox.right-this.viewport.overall.left;b.left=maxPercent/this.elementBox.width*pxIn;b.left=(b.left>100)?100:b.left}if(this.elementBox.left<this.viewport.overall.right&&this.elementBox.right>this.viewport.overall.left){pxIn=this.viewport.overall.right-this.elementBox.left;b.right=maxPercent/this.elementBox.width*pxIn;b.right=(b.right>100)?100:b.right}this.percent.overall=100*(b.top/100)*(b.bottom/100)*(b.left/100)*(b.right/100);this._setState();return(!c)?this.state.overall:this.percent.overall},inTopViewport:function(b){this._detectViewport();this._detectElementPosition();maxPercent=100/this.elementBox.height*this.viewport.top.height;maxPercent=(maxPercent>100)?100:maxPercent;if(this.elementBox.bottom>this.viewport.top.top&&this.elementBox.bottom<this.viewport.top.bottom&&this.elementBox.top<this.viewport.top.top){pxIn=this.elementBox.bottom-this.viewport.top.top;percent=maxPercent/this.elementBox.height*pxIn}else{if(this.elementBox.top>this.viewport.top.top&&this.elementBox.top<this.viewport.top.bottom&&this.elementBox.bottom>this.viewport.top.bottom){pxIn=this.viewport.top.bottom-this.elementBox.top;percent=maxPercent/this.elementBox.height*pxIn}else{if(this.elementBox.top>this.viewport.top.bottom||this.elementBox.bottom<this.viewport.top.top){percent=0}else{percent=maxPercent}}}this.percent.top=(percent>100)?100:percent;this._setState();return(!b)?this.state.top:this.percent.top},inBottomViewport:function(b){this._detectViewport();this._detectElementPosition();maxPercent=100/this.elementBox.height*this.viewport.bottom.height;maxPercent=(maxPercent>100)?100:maxPercent;if(this.elementBox.top>this.viewport.bottom.top&&this.elementBox.top<this.viewport.bottom.bottom&&this.elementBox.bottom>this.viewport.bottom.bottom){pxIn=this.viewport.bottom.bottom-this.elementBox.top;percent=maxPercent/this.elementBox.height*pxIn}else{if(this.elementBox.bottom<this.viewport.bottom.bottom&&this.elementBox.bottom>this.viewport.bottom.top&&this.elementBox.top<this.viewport.bottom.top){pxIn=this.elementBox.bottom-this.viewport.bottom.top;percent=maxPercent/this.elementBox.height*pxIn}else{if(this.elementBox.top>this.viewport.bottom.left||this.elementBox.bottom<this.viewport.bottom.right){percent=0}else{percent=maxPercent}}}this.percent.bottom=(percent>100)?100:percent;this._setState();return(!b)?this.state.bottom:this.percent.bottom},inLeftViewport:function(b){this._detectViewport();this._detectElementPosition();maxPercent=100/this.elementBox.width*this.viewport.left.width;maxPercent=(maxPercent>100)?100:maxPercent;if(this.elementBox.left<this.viewport.left.right&&this.elementBox.left>this.viewport.left.left&&this.elementBox.right>this.viewport.left.right){pxIn=this.viewport.left.right-this.elementBox.left;percent=maxPercent/this.viewport.left.width*pxIn}else{if(this.elementBox.left<this.viewport.left.left&&this.elementBox.right<this.viewport.left.right&&this.elementBox.right>this.viewport.left.left){pxIn=this.elementBox.right-this.viewport.left.left;percent=maxPercent/this.elementBox.width*pxIn}else{if(this.elementBox.left>this.viewport.left.left||this.elementBox.right<this.viewport.left.right){percent=0}else{percent=maxPercent}}}this.percent.left=(percent>100)?100:percent;this._setState();return(!b)?this.state.left:this.percent.left},inRightViewport:function(b){this._detectViewport();this._detectElementPosition();maxPercent=100/this.elementBox.width*this.viewport.right.width;maxPercent=(maxPercent>100)?100:maxPercent;if(this.elementBox.right>this.viewport.right.left&&this.elementBox.right<this.viewport.right.right&&this.elementBox.left<this.viewport.right.left){pxIn=this.elementBox.right-this.viewport.right.left;percent=maxPercent/this.elementBox.width*pxIn}else{if(this.elementBox.left>this.viewport.right.left&&this.elementBox.left<this.viewport.right.right&&this.elementBox.right>this.viewport.right.right){pxIn=this.viewport.right.right-this.elementBox.left;percent=maxPercent/this.elementBox.width*pxIn}else{if(this.elementBox.right<this.viewport.right.left||this.elementBox.left>this.viewport.right.right){percent=0}else{percent=maxPercent}}}this.percent.right=(percent>100)?100:percent;this._setState();return(!b)?this.state.right:this.percent.right},_displayViewports:function(){a(".viewport-display").remove();if(this.options.showViewports!==false){if(this.options.showViewports!=="all"){overlay=a('<div id="viewport-'+this.options.showViewports+'" class="viewport-display">').css({position:"absolute",top:this.viewport[this.options.showViewports].top,left:this.viewport[this.options.showViewports].left,height:this.viewport[this.options.showViewports].height,width:this.viewport[this.options.showViewports].width,"background-color":this.viewportDisplayColors[this.options.showViewports],opacity:0.3});a("body").append(overlay)}else{for(viewport in this.viewport){overlay=a('<div id="viewport-'+viewport+'" class="viewport-display">').css({position:"absolute",top:this.viewport[viewport].top,left:this.viewport[viewport].left,height:this.viewport[viewport].height,width:this.viewport[viewport].width,"background-color":this.viewportDisplayColors[viewport],opacity:0.3});a("body").append(overlay)}}}return true}})})(jQuery);