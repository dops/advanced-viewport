!function(t){t.widget("dops.advancedViewport",{options:{threshold:0,thresholdTop:null,thresholdBottom:null,thresholdLeft:null,thresholdRight:null,segmentation:{topBottom:"50:50",leftRight:"50:50"},showViewports:!1},viewport:{top:{top:null,bottom:null,left:null,right:null},bottom:{top:null,bottom:null,left:null,right:null},left:{top:null,bottom:null,left:null,right:null},right:{top:null,bottom:null,left:null,right:null},overall:{top:null,bottom:null,left:null,right:null}},viewportDisplayColors:{top:"red",bottom:"blue",left:"green",right:"yellow",overall:"pink"},state:{top:!1,bottom:!1,left:!1,right:!1,above:!1,below:!1,leftOf:!1,rightOf:!1,overall:!1},percent:{top:0,bottom:0,left:0,right:0,overall:0},_create:function(){return this._setThresholds(),this._addEventhandlers(),this.inViewport(),this._displayViewports(),this},_setThresholds:function(){return null===this.options.thresholdTop&&(this.options.thresholdTop=this.options.threshold),null===this.options.thresholdBottom&&(this.options.thresholdBottom=this.options.threshold),null===this.options.thresholdLeft&&(this.options.thresholdLeft=this.options.threshold),null===this.options.thresholdRight&&(this.options.thresholdRight=this.options.threshold),!0},_detectViewport:function(){return scrollTop=t(window).scrollTop(),scrollLeft=t(window).scrollLeft(),height=t(window).height(),width=t(window).width(),this.viewport.overall={top:scrollTop+this.options.thresholdTop,bottom:scrollTop+height-this.options.thresholdBottom,left:scrollLeft+this.options.thresholdLeft,right:scrollLeft+width-this.options.thresholdRight,height:height-this.options.thresholdBottom-this.options.thresholdTop,width:width-this.options.thresholdRight-this.options.thresholdLeft},segmentation=this.options.segmentation.topBottom.split(":"),topSegment=parseInt(segmentation[0],10),bottomSegment=parseInt(segmentation[1],10),this._detectTopViewport(segmentation[0]),this._detectBottomViewport(segmentation[1]),segmentation=this.options.segmentation.leftRight.split(":"),leftSegment=parseInt(segmentation[0],10),rightSegment=parseInt(segmentation[1],10),this._detectLeftViewport(segmentation[0]),this._detectRightViewport(segmentation[1]),!0},_detectTopViewport:function(t){return parseInt(t,10)==t||t.match(/%/)?(value=t.match(/%/)?parseInt(t.replace(/%/,""),10):parseInt(t,10),this.viewport.top=jQuery.extend({},this.viewport.overall),this.viewport.top.bottom=this.viewport.overall.height/100*value+this.viewport.overall.top,this.viewport.top.height=this.viewport.overall.height/100*value):t.match(/px/)&&(value=parseInt(t.replace(/px/,""),10),this.viewport.top=jQuery.extend({},this.viewport.overall),this.viewport.top.bottom=value+this.viewport.overall.top,this.viewport.top.height=value),!0},_detectBottomViewport:function(t){return parseInt(t,10)==t||t.match(/%/)?(value=t.match(/%/)?parseInt(t.replace(/%/,""),10):parseInt(t,10),this.viewport.bottom=jQuery.extend({},this.viewport.overall),this.viewport.bottom.top=this.viewport.overall.height-this.viewport.overall.height/100*value+this.viewport.overall.top,this.viewport.bottom.height=this.viewport.overall.height/100*value):t.match(/px/)&&(value=parseInt(t.replace(/px/,""),10),this.viewport.bottom=jQuery.extend({},this.viewport.overall),this.viewport.bottom.top=this.viewport.overall.height-value+this.viewport.overall.top,this.viewport.bottom.height=value),!0},_detectLeftViewport:function(t){return parseInt(t,10)==t||t.match(/%/)?(value=t.match(/%/)?parseInt(t.replace(/%/,""),10):parseInt(t,10),this.viewport.left=jQuery.extend({},this.viewport.overall),this.viewport.left.right=this.viewport.overall.width/100*leftSegment+this.viewport.overall.left,this.viewport.left.width=this.viewport.overall.width/100*leftSegment):t.match(/px/)&&(value=parseInt(t.replace(/px/,""),10),this.viewport.left=jQuery.extend({},this.viewport.overall),this.viewport.left.right=value+this.viewport.overall.left,this.viewport.left.width=value),!0},_detectRightViewport:function(t){return parseInt(t,10)==t||t.match(/%/)?(value=t.match(/%/)?parseInt(t.replace(/%/,""),10):parseInt(t,10),this.viewport.right=jQuery.extend({},this.viewport.overall),this.viewport.right.left=this.viewport.overall.width-this.viewport.overall.width/100*rightSegment+this.viewport.overall.left,this.viewport.right.width=this.viewport.overall.width/100*rightSegment):t.match(/px/)&&(value=parseInt(t.replace(/px/,""),10),this.viewport.right=jQuery.extend({},this.viewport.overall),this.viewport.right.left=this.viewport.overall.width-value+this.viewport.overall.left,this.viewport.right.width=value),!0},_detectElementPosition:function(){return offset=t(this.element).offset(),height=t(this.element).outerHeight(),width=t(this.element).outerWidth(),this.elementBox={top:offset.top,bottom:offset.top+height,left:offset.left,right:offset.left+width,height:height,width:width},!0},_addEventhandlers:function(){return that=this,this._on(t(window),{resize:"inViewport",scroll:"inViewport"}),this._on(t(window),{resize:function(t){that.inViewport(),that._displayViewports()},scroll:function(t){that.inViewport(),that._displayViewports()}}),!0},_setTopState:function(){return stateAbove=this.elementBox.bottom<this.viewport.top.top?!0:!1,stateAbove!==this.state.above&&(this.state.above=stateAbove,this._trigger(stateAbove?"aboveViewport":"notAboveViewport",null,{state:this.state,percent:this.percent})),stateTop=this.percent.top>0?!0:!1,stateTop!==this.state.top&&(this.state.top=stateTop,this._trigger(stateTop?"inTopViewport":"notInTopViewport",null,{state:this.state,percent:this.percent})),!0},_setBottomState:function(){return stateBelow=this.elementBox.top>this.viewport.bottom.left?!0:!1,stateBelow!==this.state.below&&(this.state.below=stateBelow,this._trigger(stateBelow?"belowViewport":"notBelowViewport",null,{state:this.state,percent:this.percent})),stateBottom=this.percent.bottom>0?!0:!1,stateBottom!==this.state.bottom&&(this.state.bottom=stateBottom,this._trigger(stateBottom?"inBottomViewport":"notInBottomViewport",null,{state:this.state,percent:this.percent})),!0},_setLeftState:function(){return stateLeftOf=this.elementBox.right<this.viewport.left.left?!0:!1,stateLeftOf!==this.state.leftOf&&(this.state.leftOf=stateLeftOf,this._trigger(stateLeftOf?"leftOfViewport":"notLeftOfViewport",null,{state:this.state,percent:this.percent})),stateLeft=this.percent.left>0?!0:!1,stateLeft!==this.state.left&&(this.state.left=stateLeft,this._trigger(stateLeft?"inLeftViewport":"notInLeftViewport",null,{state:this.state,percent:this.percent})),!0},_setRightState:function(){return stateRightOf=this.elementBox.left>this.viewport.right.right?!0:!1,stateRightOf!==this.state.rightOf&&(this.state.rightOf=stateRightOf,this._trigger(stateRightOf?"rightOfViewport":"notRightOfViewport",null,{state:this.state,percent:this.percent})),stateRight=this.percent.right>0?!0:!1,stateRight!==this.state.right&&(this.state.right=stateRight,this._trigger(stateRight?"inRightViewport":"notInRightViewport",null,{state:this.state,percent:this.percent})),!0},_setOverallState:function(){return stateOverall=this.percent.overall>0?!0:!1,stateOverall!==this.state.overall&&(this.state.overall=stateOverall,this._trigger(stateOverall===!0?"inViewport":"notInViewport",null,{state:this.state,percent:this.percent})),!0},_setState:function(){return oldPercent=this.percent,this._setTopState(),this._setBottomState(),this._setLeftState(),this._setRightState(),this._setOverallState(),this._manageClassAdditions(),JSON.stringify(oldPercent)===JSON.stringify(this.percent)&&this._trigger("positionUpdate",null,{state:this.state,percent:this.percent}),!0},_manageClassAdditions:function(){inAnyViewport=!1,elem=t(this.element);for(viewport in this.state)this.state[viewport]===!0?(inAnyViewport=!0,elem.addClass("in-"+viewport+"-viewport")):elem.removeClass("in-"+viewport+"-viewport");return inAnyViewport?elem.addClass("in-viewport"):elem.removeClass("in-viewport"),!0},inViewport:function(t){this._detectViewport(),this._detectElementPosition(),this.inTopViewport(),this.inBottomViewport(),this.inLeftViewport(),this.inRightViewport(),maxPercent=this.elementBox.height/100*this.viewport.overall.height,maxPercent=maxPercent>100?100:maxPercent;var e={top:0,bottom:0,left:0,right:0};return this.elementBox.bottom>this.viewport.overall.top&&this.elementBox.top<this.viewport.overall.bottom&&(pxIn=this.elementBox.bottom-this.viewport.overall.top,e.top=maxPercent/this.elementBox.height*pxIn,e.top=e.top>100?100:e.top),this.elementBox.top<this.viewport.overall.bottom&&this.elementBox.bottom>this.viewport.overall.top&&(pxIn=this.viewport.overall.bottom-this.elementBox.top,e.bottom=maxPercent/this.elementBox.height*pxIn,e.bottom=e.bottom>100?100:e.bottom),this.elementBox.right>this.viewport.overall.left&&this.elementBox.left<this.viewport.overall.right&&(pxIn=this.elementBox.right-this.viewport.overall.left,e.left=maxPercent/this.elementBox.width*pxIn,e.left=e.left>100?100:e.left),this.elementBox.left<this.viewport.overall.right&&this.elementBox.right>this.viewport.overall.left&&(pxIn=this.viewport.overall.right-this.elementBox.left,e.right=maxPercent/this.elementBox.width*pxIn,e.right=e.right>100?100:e.right),this.percent.overall=100*(e.top/100)*(e.bottom/100)*(e.left/100)*(e.right/100),this._setState(),t?this.percent.overall:this.state.overall},inTopViewport:function(t){return this._detectViewport(),this._detectElementPosition(),maxPercent=100/this.elementBox.height*this.viewport.top.height,maxPercent=maxPercent>100?100:maxPercent,this.elementBox.bottom>this.viewport.top.top&&this.elementBox.bottom<this.viewport.top.bottom&&this.elementBox.top<this.viewport.top.top?(pxIn=this.elementBox.bottom-this.viewport.top.top,percent=maxPercent/this.elementBox.height*pxIn):this.elementBox.top>this.viewport.top.top&&this.elementBox.top<this.viewport.top.bottom&&this.elementBox.bottom>this.viewport.top.bottom?(pxIn=this.viewport.top.bottom-this.elementBox.top,percent=maxPercent/this.elementBox.height*pxIn):this.elementBox.top>this.viewport.top.bottom||this.elementBox.bottom<this.viewport.top.top?percent=0:percent=maxPercent,this.percent.top=percent>100?100:percent,this._setState(),t?this.percent.top:this.state.top},inBottomViewport:function(t){return this._detectViewport(),this._detectElementPosition(),maxPercent=100/this.elementBox.height*this.viewport.bottom.height,maxPercent=maxPercent>100?100:maxPercent,this.elementBox.top>this.viewport.bottom.top&&this.elementBox.top<this.viewport.bottom.bottom&&this.elementBox.bottom>this.viewport.bottom.bottom?(pxIn=this.viewport.bottom.bottom-this.elementBox.top,percent=maxPercent/this.elementBox.height*pxIn):this.elementBox.bottom<this.viewport.bottom.bottom&&this.elementBox.bottom>this.viewport.bottom.top&&this.elementBox.top<this.viewport.bottom.top?(pxIn=this.elementBox.bottom-this.viewport.bottom.top,percent=maxPercent/this.elementBox.height*pxIn):this.elementBox.top>this.viewport.bottom.left||this.elementBox.bottom<this.viewport.bottom.right?percent=0:percent=maxPercent,this.percent.bottom=percent>100?100:percent,this._setState(),t?this.percent.bottom:this.state.bottom},inLeftViewport:function(t){return this._detectViewport(),this._detectElementPosition(),maxPercent=100/this.elementBox.width*this.viewport.left.width,maxPercent=maxPercent>100?100:maxPercent,this.elementBox.left<this.viewport.left.right&&this.elementBox.left>this.viewport.left.left&&this.elementBox.right>this.viewport.left.right?(pxIn=this.viewport.left.right-this.elementBox.left,percent=maxPercent/this.viewport.left.width*pxIn):this.elementBox.left<this.viewport.left.left&&this.elementBox.right<this.viewport.left.right&&this.elementBox.right>this.viewport.left.left?(pxIn=this.elementBox.right-this.viewport.left.left,percent=maxPercent/this.elementBox.width*pxIn):this.elementBox.left>this.viewport.left.left||this.elementBox.right<this.viewport.left.right?percent=0:percent=maxPercent,this.percent.left=percent>100?100:percent,this._setState(),t?this.percent.left:this.state.left},inRightViewport:function(t){return this._detectViewport(),this._detectElementPosition(),maxPercent=100/this.elementBox.width*this.viewport.right.width,maxPercent=maxPercent>100?100:maxPercent,this.elementBox.right>this.viewport.right.left&&this.elementBox.right<this.viewport.right.right&&this.elementBox.left<this.viewport.right.left?(pxIn=this.elementBox.right-this.viewport.right.left,percent=maxPercent/this.elementBox.width*pxIn):this.elementBox.left>this.viewport.right.left&&this.elementBox.left<this.viewport.right.right&&this.elementBox.right>this.viewport.right.right?(pxIn=this.viewport.right.right-this.elementBox.left,percent=maxPercent/this.elementBox.width*pxIn):this.elementBox.right<this.viewport.right.left||this.elementBox.left>this.viewport.right.right?percent=0:percent=maxPercent,this.percent.right=percent>100?100:percent,this._setState(),t?this.percent.right:this.state.right},_displayViewports:function(){if(t(".viewport-display").remove(),this.options.showViewports!==!1)if("all"!==this.options.showViewports)overlay=t('<div id="viewport-'+this.options.showViewports+'" class="viewport-display">').css({position:"absolute",top:this.viewport[this.options.showViewports].top,left:this.viewport[this.options.showViewports].left,height:this.viewport[this.options.showViewports].height,width:this.viewport[this.options.showViewports].width,"background-color":this.viewportDisplayColors[this.options.showViewports],opacity:.3}),t("body").append(overlay);else for(viewport in this.viewport)overlay=t('<div id="viewport-'+viewport+'" class="viewport-display">').css({position:"absolute",top:this.viewport[viewport].top,left:this.viewport[viewport].left,height:this.viewport[viewport].height,width:this.viewport[viewport].width,"background-color":this.viewportDisplayColors[viewport],opacity:.3}),t("body").append(overlay);return!0}})}(jQuery);